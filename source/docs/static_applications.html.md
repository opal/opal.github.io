# Static Building

`opal` makes it easy to build static opal applications. Opal uses internal load
paths to make it easy to handle resolving requirements during building. `opal`
forms the basis of rails support, so anything you can do there, you can do
standalone as well.

## Overview

First, install `opal` adding them to a `Gemfile`:

```ruby
# Gemfile
gem "opal", ">= 0.8.0"
```

Next, we want to add our main app code. Keep all opal code inside `app/`
directory, and edit `app/application.rb`:

```ruby
# app/application.rb
require "opal"

puts "Wow, running opal!"
```

You will notice the `require "opal"` line which will automatically include the
opal runtime and corelib into our output, giving us access to the `puts()`
method.

To build this, we can use a rake task to add our
`app/` directory to the load path, and then to build our target file `build.js` from
`application.rb` which will be found because it is inside our added load path.

If you want to use gems installed on your build machine, tell Opal so that Opal can find it
(e.g. `Opal.use_gem "faker"`). If you require a gem it will be required during the compilation 
process and will be included into the generated JavaScript. 

```ruby
# Rakefile
require 'opal'

desc "Build our app to build.js"
task :build do
  Opal.append_path "app"
  Opal.use_gem "faker"
  
  File.binwrite "build.js", Opal::Builder.build("application").to_s
end
```

Now, if you run `rake build` you will get the `build.js` output file with our
application compiled, with the opal runtime included as well.

To run the application, lets create a very simple html file:

```html
<!DOCTYPE html>
<html>
  <head>
    <script src="build.js"></script>
  </head>
  <body>
  </body>
</html>
```

Now, open this html file and check the browsers console. You should see our
message printed in the console.


Note that you can also use sprockets to build the target if you want to.

Dependency management is delegated directly to sprockets.
This means code generated by sprockets will always need to be bootstrapped 
via `Opal.load` or `Opal.require`. Luckily `Opal::Processor.load_asset_code(sprockets, name)`
does just that in the right way.

```ruby
# Rakefile
require 'opal'

desc "Build our app to build.js"
task :build do

  env = Sprockets::Environment.new

  Opal::Processor.source_map_enabled = true
  Opal.append_path "app"
  Opal.use_gem "faker"

  Opal.paths.each { |p| env.append_path(p) }

  File.open("build.js", "w+") do |out|
    out << env["application"].to_s
    out << Opal::Processor.load_asset_code(env, 'application')
  end
end
```
