# Opal Compiler

Opal is a source-to-source compiler. It accepts Ruby code as a string and
generates JavaScript code which can be run in any environment. Generated
code relies on the Opal runtime which provides the class system and some
other runtime helpers.

## Compiler stages

The compiler can be broken down into 3 separate stages:

* lexing
* parsing
* code generation

### Lexer

The [Opal lexer][lexer] is implemented in pure Ruby using
the `StringScanner` class from the Opal stdlib. The source code is scanned
and tokens are then provided to the parser. This process simply converts
the Ruby code given as a string, into a list of tokens representing the
parts of the Ruby code.

### Parser

The [Opal parser][parser] is implemented using a standard
bison like syntax, but relies on `racc`, a Ruby implementation of yacc/bison
which is again available in the standard library. The parser takes these tokens
generated by the lexer and builds a syntax tree representing the Ruby code.
This syntax tree is represented by [sexps][sexps]. As
Ruby is such a complex and dynamic language, there is a lot of interaction
between the parser and the lexer, namely through a preserved `lex_state`.

### Code generation

The [Opal compiler][compiler] takes these sexps from the parser
and generates Ruby code from them. Each type of sexp has [its own node type][base-node]
used to generate JavaScript. Each node creates an array of one or more
[fragments][fragments] which are the concatendated together to
form the final JavaScript. Fragments are used as they contain the generated
code as well as a reference back to the original sexp which is useful for
generating source maps afterwards.


[lexer]: https://github.com/opal/opal/tree/master/lib/opal/parser/lexer.rb
[parser]: https://github.com/opal/opal/tree/master/lib/opal/parser/grammar.y
[sexps]: https://github.com/opal/opal/tree/master/lib/opal/parser/sexp.rb
[compiler]: https://github.com/opal/opal/tree/master/lib/opal/compiler.rb
[fragments]: https://github.com/opal/opal/tree/master/lib/opal/fragment.rb
[base-node]: https://github.com/opal/opal/tree/master/lib/opal/nodes/base.rb
