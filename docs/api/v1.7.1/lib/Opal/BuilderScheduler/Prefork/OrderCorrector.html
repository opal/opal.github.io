<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Opal::BuilderScheduler::Prefork::OrderCorrector
  
    &mdash; lib (Opal v1.7.1)
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Opal::BuilderScheduler::Prefork::OrderCorrector";
  relpath = '../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  <span class="title"><a href="/docs">Opal Docs</a></span>
  
    &raquo;
    <a href="../../../_index.html">Index (O)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Opal.html" title="Opal (module)">Opal</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../BuilderScheduler.html" title="Opal::BuilderScheduler (class)">BuilderScheduler</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Prefork.html" title="Opal::BuilderScheduler::Prefork (class)">Prefork</a></span></span>
     &raquo; 
    <span class="title">OrderCorrector</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Opal::BuilderScheduler::Prefork::OrderCorrector
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>opal/lib/opal/builder_scheduler/prefork.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Prefork is not deterministic. This module corrects an order of processed
files so that it would be exactly the same as if building sequentially.
While for Ruby files it usually isn&#39;t a problem, because the real order
stems from how <code>Opal.modules</code> array is accessed, the JavaScript files
are executed verbatim and their order may be important. Also, having
deterministic output is always a good thing.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_require_order_array-class_method" title="build_require_order_array (class method)">.<strong>build_require_order_array</strong>(requires, requires_hash, built_for = Set.new)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#correct_order-class_method" title="correct_order (class method)">.<strong>correct_order</strong>(processed, requires, builder)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#expand_requires-class_method" title="expand_requires (class method)">.<strong>expand_requires</strong>(requires, builder)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Expand a requires array, so that the requires filenames will be matching BuilderProcessor#.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="build_require_order_array-class_method">
  
    .<strong>build_require_order_array</strong>(requires, requires_hash, built_for = Set.new)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


61
62
63
64
65
66
67
68
69
70
71
72</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'opal/lib/opal/builder_scheduler/prefork.rb', line 61</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_require_order_array'>build_require_order_array</span><span class='lparen'>(</span><span class='id identifier rubyid_requires'>requires</span><span class='comma'>,</span> <span class='id identifier rubyid_requires_hash'>requires_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_built_for'>built_for</span> <span class='op'>=</span> <span class='const'>Set</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_array'>array</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_requires'>requires</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_name'>name</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_built_for'>built_for</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_built_for'>built_for</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_name'>name</span>

    <span class='id identifier rubyid_asset_requires'>asset_requires</span> <span class='op'>=</span> <span class='id identifier rubyid_requires_hash'>requires_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_array'>array</span> <span class='op'>+=</span> <span class='id identifier rubyid_build_require_order_array'>build_require_order_array</span><span class='lparen'>(</span><span class='id identifier rubyid_asset_requires'>asset_requires</span><span class='comma'>,</span> <span class='id identifier rubyid_requires_hash'>requires_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_built_for'>built_for</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_asset_requires'>asset_requires</span>
    <span class='id identifier rubyid_array'>array</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_array'>array</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="correct_order-class_method">
  
    .<strong>correct_order</strong>(processed, requires, builder)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'opal/lib/opal/builder_scheduler/prefork.rb', line 36</span>

<span class='kw'>def</span> <span class='id identifier rubyid_correct_order'>correct_order</span><span class='lparen'>(</span><span class='id identifier rubyid_processed'>processed</span><span class='comma'>,</span> <span class='id identifier rubyid_requires'>requires</span><span class='comma'>,</span> <span class='id identifier rubyid_builder'>builder</span><span class='rparen'>)</span>
  <span class='comment'># Let&#39;s build a hash that maps a filename to an array of files it requires
</span>  <span class='id identifier rubyid_requires_hash'>requires_hash</span> <span class='op'>=</span> <span class='id identifier rubyid_processed'>processed</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_expand_requires'>expand_requires</span><span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span><span class='period'>.</span><span class='id identifier rubyid_requires'>requires</span><span class='comma'>,</span> <span class='id identifier rubyid_builder'>builder</span><span class='rparen'>)</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
  <span class='comment'># Let&#39;s build an array with a correct order of requires
</span>  <span class='id identifier rubyid_order_array'>order_array</span> <span class='op'>=</span> <span class='id identifier rubyid_build_require_order_array'>build_require_order_array</span><span class='lparen'>(</span><span class='id identifier rubyid_expand_requires'>expand_requires</span><span class='lparen'>(</span><span class='id identifier rubyid_requires'>requires</span><span class='comma'>,</span> <span class='id identifier rubyid_builder'>builder</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_requires_hash'>requires_hash</span><span class='rparen'>)</span>
  <span class='comment'># If a key is duplicated, remove the last duplicate
</span>  <span class='id identifier rubyid_order_array'>order_array</span> <span class='op'>=</span> <span class='id identifier rubyid_order_array'>order_array</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
  <span class='comment'># Create a hash from this array: [a,b,c] =&gt; [a =&gt; 0, b =&gt; 1, c =&gt; 2]
</span>  <span class='id identifier rubyid_order_hash'>order_hash</span> <span class='op'>=</span> <span class='id identifier rubyid_order_array'>order_array</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='comment'># Let&#39;s return a processed array that has elements in the order provided
</span>  <span class='id identifier rubyid_processed'>processed</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_asset'>asset</span><span class='op'>|</span>
    <span class='comment'># If a filename isn&#39;t present somehow in our hash, let&#39;s put it at the end
</span>    <span class='id identifier rubyid_order_hash'>order_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_asset'>asset</span><span class='period'>.</span><span class='id identifier rubyid_filename'>filename</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_order_array'>order_array</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="expand_requires-class_method">
  
    .<strong>expand_requires</strong>(requires, builder)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Expand a requires array, so that the requires filenames will be
matching BuilderProcessor#. Builder needs to be passed so that
we can access an <code>expand_ext</code> function from its context.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'opal/lib/opal/builder_scheduler/prefork.rb', line 57</span>

<span class='kw'>def</span> <span class='id identifier rubyid_expand_requires'>expand_requires</span><span class='lparen'>(</span><span class='id identifier rubyid_requires'>requires</span><span class='comma'>,</span> <span class='id identifier rubyid_builder'>builder</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_requires'>requires</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='id identifier rubyid_builder'>builder</span><span class='period'>.</span><span class='id identifier rubyid_expand_ext'>expand_ext</span><span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on 01/06/23 by
  <!-- <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a> -->
  0.9.28 (ruby-2.7.5).
</div>

    </div>
  </body>
</html>