<!doctype html>
<html style="background-color: #f5f5f5; min-height: 100%;">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Opal: Ruby to Javascript compiler</title>

  <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />
  <link href="http://code.ionicframework.com/ionicons/1.4.1/css/ionicons.min.css" rel="stylesheet" type="text/css" />
  <script src="/javascripts/application.js" type="text/javascript"></script>
</head>
<body class="docs docs_compiler docs_compiler_index">
  <nav class='navbar navbar-default opal-nav' role='navigation'>
  <div class='container'>
    <div class='navbar-header'>
      <a class='navbar-brand' href='/'>
        <img height='22' src='https://secure.gravatar.com/avatar/88298620949a6534d403da2e356c9339?s=420&amp;d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-org-420.png' style='margin-top:-10%;' width='22'>
        Opal
      </a>
      <button class='navbar-toggle' data-target='#opal-navbar' data-toggle='collapse' type='button'>
        <span class='icon-bar'></span>
        <span class='icon-bar'></span>
        <span class='icon-bar'></span>
      </button>
    </div>
    <div class='navbar-collapse collapse' id='opal-navbar'>
      <ul class='nav navbar-nav'>
        <li>
          <a href='/try'>
            <i class='ion-ios7-compose'></i>
            Try
          </a>
        </li>
        <li>
          <a href='/blog'>
            <i class='ion-ios7-chatboxes'></i>
            Blog
          </a>
        </li>
        <li>
          <a href='/docs'>
            <i class='ion-ios7-copy'></i>
            Documentation
          </a>
        </li>
        <li>
          <a href='/libraries'>
            <i class='ion-android-developer'></i>
            Libraries
          </a>
        </li>
        <li>
          <a href='https://github.com/opal/opal#readme'>
            <i class='ion-social-github'></i>
            GitHub
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <script>$('a[href="'+location.pathname.replace(/\/$/,'')+'"]').parent().addClass('active')</script>

  <div class="container">
      <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <h1></h1>
      </div>
    </div>
    <div class="row">
      <div class="col-md-4 col-md-push-8">
        <ul class="nav opal-sidebar">
<li class="toc-list-chapter"><a href="#compiler-stages">Compiler stages</a>
<ul class="subchapter">
<li class="toc-list-subchapter"><a href="#lexer">Lexer</a>
<li class="toc-list-subchapter"><a href="#parser">Parser</a>
<li class="toc-list-subchapter"><a href="#code-generation">Code generation</a></li>
</ul></li></ul>
      </div>

      <div class="col-md-8 col-md-pull-4">
        <h1 id="opal-compiler">Opal Compiler</h1>

<p>Opal is a source-to-source compiler. It accepts Ruby code as a string and
generates JavaScript code which can be run in any environment. Generated
code relies on the Opal runtime which provides the class system and some
other runtime helpers.</p>

<h2 id="compiler-stages">Compiler stages</h2>

<p>The compiler can be broken down into 3 separate stages:</p>

<ul>
<li>lexing</li>
<li>parsing</li>
<li>code generation</li>
</ul>

<h3 id="lexer">Lexer</h3>

<p>The <a href="https://github.com/opal/opal/tree/master/lib/opal/parser/lexer.rb">Opal lexer</a> is implemented in pure Ruby using
the <code>StringScanner</code> class from the Opal stdlib. The source code is scanned
and tokens are then provided to the parser. This process simply converts
the Ruby code given as a string, into a list of tokens representing the
parts of the Ruby code.</p>

<h3 id="parser">Parser</h3>

<p>The <a href="https://github.com/opal/opal/tree/master/lib/opal/parser/grammar.y">Opal parser</a> is implemented using a standard
bison like syntax, but relies on <code>racc</code>, a Ruby implementation of yacc/bison
which is again available in the standard library. The parser takes these tokens
generated by the lexer and builds a syntax tree representing the Ruby code.
This syntax tree is represented by <a href="https://github.com/opal/opal/tree/master/lib/opal/parser/sexp.rb">sexps</a>. As
Ruby is such a complex and dynamic language, there is a lot of interaction
between the parser and the lexer, namely through a preserved <code>lex_state</code>.</p>

<h3 id="code-generation">Code generation</h3>

<p>The <a href="https://github.com/opal/opal/tree/master/lib/opal/compiler.rb">Opal compiler</a> takes these sexps from the parser
and generates Ruby code from them. Each type of sexp has <a href="https://github.com/opal/opal/tree/master/lib/opal/nodes/base.rb">its own node type</a>
used to generate JavaScript. Each node creates an array of one or more
<a href="https://github.com/opal/opal/tree/master/lib/opal/fragment.rb">fragments</a> which are the concatendated together to
form the final JavaScript. Fragments are used as they contain the generated
code as well as a reference back to the original sexp which is useful for
generating source maps afterwards.</p>

      </div>
    </div>
  </div>

  </div>

  <!-- GOOGLE ANALYTICS -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35688734-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<footer>
  <a href="/license"><i class="ion-unlocked"></i> License</a> Â·
  <a href="https://github.com/opal/opal/graphs/contributors"><i class="ion-fork-repo"></i> Contributors</a>
</footer>


  <script>
    $('a[href="'+location.pathname.replace(/\/$/,'')+'"]').parent('li').addClass('active')
  </script>
</body>
</html>
