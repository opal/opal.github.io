<!doctype html>
<html style="background-color: #f5f5f5; min-height: 100%;">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Opal 1.3</title>

  <link href="/assets/application-915b7e3cafe6e192dee011fa09837b2af85b7e1de3dbb52fd1413d46dd2dca0e.css" rel="stylesheet" />
  <link href="//code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet" />

  <script src="/assets/application-596f523b41cd0c1b75b8066512c4c9b592e85ce699428a05db4d6ac425c2b09f.js" onload="Opal.loaded(typeof(OpalLoaded) === &quot;undefined&quot; ? [] : OpalLoaded);
Opal.require(&quot;application&quot;);;console.log('loaded application')"></script>

  <!-- Algolia -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>
<body class="blog blog_2021 blog_2021_11 blog_2021_11_03 blog_2021_11_03_opal-1-3 blog_2021_11_03_opal-1-3_index">
  <nav class='navbar navbar-default opal-nav' role='navigation'>
<div class='container'>
<div class='navbar-header'>
<a class='navbar-brand' href='/'>
<img height='22' src='https://secure.gravatar.com/avatar/88298620949a6534d403da2e356c9339?s=420&amp;d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-org-420.png' style='margin-top:-10%;' width='22'>
Opal
</a>
<button class='navbar-toggle' data-target='#opal-navbar' data-toggle='collapse' type='button'>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</button>
</div>
<div class='navbar-collapse collapse' id='opal-navbar'>
<ul class='nav navbar-nav'>
<li>
<a href='/try'>
<i class='ion-ios-compose'></i>
Try
</a>
</li>
<li>
<a href='/blog'>
<i class='ion-ios-chatboxes'></i>
Blog
</a>
</li>
<li>
<a href='/docs'>
<i class='ion-ios-copy'></i>
Documentation
</a>
</li>
<li>
<a href='/libraries'>
<i class='ion-map'></i>
Libraries
</a>
</li>
<li>
<a href='https://github.com/opal/opal#readme'>
<i class='ion-social-github'></i>
GitHub
</a>
</li>
<li>
<a href='https://rubygems.org/gems/opal/versions/1.8.2' style='opacity: 0.5;'>
v1.8.2
</a>
</li>
</ul>
<ul class='nav navbar-right'>
<li class='search-bar'>
<form id='search-form'>
<input placeholder='Search docs &amp; guides' type='search'>
<button title='Clear the search query.' type='reset'>
&times;
</button>
</form>
</li>
</ul>
</div>
</div>
</nav>


  <div class="container">
      <div class="container col-sm-8">
    <div class='blog-title'>
<h1>
<a href='/blog'>The Opal Blog</a>
</h1>
</div>

    <article class='blog-post'>
<header>
<h2 class='blog-post-title'>
<a href=''>
Opal 1.3
</a>
</h2>
<div class='blog-post-meta'>
Posted by hmdne
<br>
November 03, 2021
</div>
</header>
<div class='blog-post-body'>
<p>We have released Opal v1.3.0 a week ago and today we are releasing Opal v1.3.1 containing a few last minute fixes. We plan Opal v1.3 to be supported with a best-effort principle for a longer term, backporting bugfixes.</p>&#x000A;&#x000A;<p>This is quite a big release with a special focus on developer tools and error reporting improvements.</p>&#x000A;&#x000A;<div id="continue-reading"></div>&#x000A;&#x000A;<h2 id="preliminary-es-modules-support">Preliminary ES Modules support</h2>&#x000A;&#x000A;<p>Although we didn&#39;t yet fully integrate with Webpack as originally planned, Jan Biedermann (of the Isomorfeus project) contributed some preliminary ES Modules support.</p>&#x000A;&#x000A;<p>If you use Isomorfeus you can take advantage of it with its ESBuild integration and the newly added autoload hooks, which finally works without requiring a patched version of Opal.</p>&#x000A;&#x000A;<p>If you don&#39;t use it you can still roll your own integration, making autoload dynamically fetch modules from the server as they&#39;re imported.</p>&#x000A;&#x000A;<p>We are planning to work on a proper <code>import</code> and npm package support for the next release, along with Ruby 3.1 support.</p>&#x000A;&#x000A;<h2 id="newly-supported-language-features">Newly supported language features</h2>&#x000A;&#x000A;<p>We already support a lot of Ruby 3.0 features. This release fills a few missing gaps, most of which will only be used in very niche usecases.</p>&#x000A;&#x000A;<h3 id="refinements">Refinements</h3>&#x000A;&#x000A;<p>Refinements are now mostly supported. If you don&#39;t like monkey patching, this feature can improve your codebase.</p>&#x000A;&#x000A;<h3 id="binding"><code>binding</code></h3>&#x000A;&#x000A;<p>Binding allows you to take a peek at local variables in a given scope. You probably most likely know it for <code>binding.irb</code> or <code>binding.pry</code> - while we don&#39;t support those yet, it&#39;s now only a matter of time when it gets implemented - all prerequisites are there already.</p>&#x000A;&#x000A;<h3 id="autoload"><code>autoload</code></h3>&#x000A;&#x000A;<p>Autoload statements will cause a file to be included inside your Opal bundle, but won&#39;t load it instantly. We moved a bigger deal of corelib to benefit from faster load times.</p>&#x000A;&#x000A;<p>This support can also be used to load files dynamically, like <code>opal-zeitwerk</code> does in Isomorfeus.</p>&#x000A;&#x000A;<h3 id="retry"><code>retry</code></h3>&#x000A;&#x000A;<p>Due to an asynchronous nature of JavaScript, it probably won&#39;t have much use here. But still, you can now use this statement to restart the code in a rescue clause.</p>&#x000A;&#x000A;<h3 id="super-improvements"><code>super</code> improvements</h3>&#x000A;&#x000A;<p>The following code used to call a super function with <code>(a,b,c)</code> arguments, now it correctly calls it with <code>(4,b,c)</code>. Also a few more edge cases were corrected.</p>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>&#x000A;  <span class="n">a</span> <span class="o">=</span> <span class="mi">4</span>&#x000A;  <span class="k">super</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h3 id="stdin-and-gets-support"><code>stdin</code> and <code>gets</code> support</h3>&#x000A;&#x000A;<p>We have now a larger synchronous IO support. <code>gets</code> is implemented on a browser via <code>prompt</code> (aka that annoying alert popup with a text field), on other platforms, including headless chrome, it bridges <code>stdin</code> properly.</p>&#x000A;&#x000A;<p><strong>Reminder:</strong> for basic support of other platforms than browser, you need to <code>require &quot;opal/platform&quot;</code>. For extended support of NodeJS, you need to <code>require &quot;nodejs&quot;</code>.</p>&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ opal -ropal/platform -e 'p gets'&#x000A;123&#x000A;"123\n"&#x000A;</code></pre></div>&#x000A;<p><em>Implementing <code>gets</code> is all that&#39;s needed to make a runner able to be ran in the REPL mode</em></p>&#x000A;&#x000A;<h3 id="global-variable-aliases">Global variable aliases</h3>&#x000A;&#x000A;<p>Certainly a lesser known feature of Ruby. Did you know it&#39;s possible to write this:</p>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="k">alias</span> <span class="vg">$PROGRAM_NAME</span> <span class="vg">$0</span>&#x000A;<span class="vg">$PROGRAM_NAME</span> <span class="o">=</span> <span class="s2">"abc"</span> <span class="c1"># This changes $0 as well!</span>&#x000A;</code></pre></div>&#x000A;<p>Opal has you covered.</p>&#x000A;&#x000A;<h3 id="flip-flop">Flip-flop</h3>&#x000A;&#x000A;<p>This Perl-inspired feature was almost removed in Ruby 3.0. But due to some interest, it was actually fixed. Opal now supports this as well! Have you never heard of this feature? That&#39;s fair, it mostly isn&#39;t present in production code, but can be used for writing unreadable code like this:</p>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="n">a</span><span class="o">=</span><span class="n">b</span><span class="o">=</span><span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">100</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">num</span><span class="o">|</span>&#x000A;  <span class="nb">print</span> <span class="n">num</span><span class="p">,</span> <span class="sc">?\r</span><span class="p">,</span>&#x000A;    <span class="p">(</span><span class="s2">"Fizz"</span> <span class="k">unless</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="o">!</span><span class="n">a</span><span class="p">)</span> <span class="o">..</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="o">!</span><span class="n">a</span><span class="p">)),</span>&#x000A;    <span class="p">(</span><span class="s2">"Buzz"</span> <span class="k">unless</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="o">!</span><span class="n">b</span><span class="p">)</span> <span class="o">...</span> <span class="o">!</span><span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="o">..</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">!</span><span class="n">c</span><span class="p">))),</span>&#x000A;    <span class="sc">?\n</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre></div>&#x000A;<h2 id="toolkit-improvements">Toolkit improvements</h2>&#x000A;&#x000A;<h3 id="opal-repl">opal-repl</h3>&#x000A;&#x000A;<p>The <code>opal-repl</code> command line tool gained a number of improvements:</p>&#x000A;&#x000A;<ul>&#x000A;<li>Windows support</li>&#x000A;<li>Colored output</li>&#x000A;<li>Support for printing native JS Objects / null / undefined</li>&#x000A;<li>Pry-like <code>ls</code> support</li>&#x000A;<li>Support for everything that opal command line tool supports</li>&#x000A;<li>Support for multiple runners: nodejs, chrome, gjs, quickjs, miniracer (used to be miniracer only)</li>&#x000A;</ul>&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ opal-repl&#x000A;&gt;&gt; ls 123&#x000A;Comparable#methods: between?  clamp&#x000A;Numeric#methods: __coerced__  clone  conj  conjugate  div  dup  i  imag  imaginary  polar  pretty_print  pretty_print_cycle  real  real?  rect  rectangular  step  to_c  to_json  to_n&#x000A;Number#methods: %  &amp;  *  **  +  +@  -  -@  /  &lt;  &lt;&lt;  &lt;=  &lt;=&gt;  ==  ===  &gt;  &gt;=  &gt;&gt;  []  ^  __id__  abs  abs2  allbits?  angle  anybits?  arg  bit_length  ceil  chr  coerce  denominator  digits  divmod  downto  eql?  equal?  even?  fdiv  finite?  floor  gcd  gcdlcm  infinite?  inspect  instance_of?  integer?  is_a?  kind_of?  lcm  magnitude  modulo  nan?  negative?  next  nobits?  nonzero?  numerator  object_id  odd?  ord  phase  positive?  pow  pred  quo  rationalize  remainder  round  size  succ  times  to_f  to_i  to_int  to_r  to_s  truncate  upto  zero?  |  ~&#x000A;&gt;&gt;&#x000A;$ opal-repl -Rchrome&#x000A;&gt;&gt; require 'native'&#x000A;=&gt; true&#x000A;&gt;&gt; $$[:navigator][:userAgent]&#x000A;=&gt; "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/95.0.4638.54 Safari/537.36"&#x000A;&gt;&gt;&#x000A;</code></pre></div>&#x000A;<h3 id="new-runners">New runners</h3>&#x000A;&#x000A;<p>Runners are how you can use different environments to run Opal code on, using our <code>opal</code> command line tool. We added support for 3 new runners:</p>&#x000A;&#x000A;<ul>&#x000A;<li><code>gjs</code> - the GNOME JavaScript engine based on Gecko&#39;s JS engine</li>&#x000A;<li><code>quickjs</code> - an independently developed JavaScript engine with a good embedding support: https://bellard.org/quickjs/</li>&#x000A;<li><code>miniracer</code> - Ruby bindings to pure V8 (used to be supported only for repl)</li>&#x000A;</ul>&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ opal -ropal/platform -Rchrome -e 'p OPAL_PLATFORM'&#x000A;"headless-chrome"&#x000A;$ opal -ropal/platform -Rnodejs -e 'p OPAL_PLATFORM'&#x000A;"nodejs"&#x000A;$ opal -ropal/platform -Rgjs -e 'p OPAL_PLATFORM'&#x000A;"gjs"&#x000A;$ opal -ropal/platform -Rquickjs -e 'p OPAL_PLATFORM'&#x000A;"quickjs"&#x000A;$ opal -ropal/platform -Rminiracer -e 'p OPAL_PLATFORM'&#x000A;"opal-miniracer"&#x000A;</code></pre></div>&#x000A;<p>While the support for those is preliminary and works only with <code>stdio</code>, there is a possibility to extend those implementations when needed (patches welcome!). GJS is now one of the primary GNOME development platforms, powering software like <a href="https://github.com/tchx84/Flatseal">Flatseal</a>, allowing you to bridge all GNOME libraries, like Glib or GTK4 (making it a fully featured Node.js alternative, though much more low level and a lot less popular - but that&#39;s a digression).</p>&#x000A;&#x000A;<h3 id="source-map-debugger">Source map debugger</h3>&#x000A;&#x000A;<p>We have improved the source map support in this release. It should now much more accurately tell you which line/column is being executed. Which means - easier debugging! And that&#39;s not all, if source mapping goes wrong, you can always use our new source map debugging tool:</p>&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ opal --debug-source-map -e '[1,2,3,4].each { |i| p i }'&#x000A;https://sokra.github.io/source-map-visualization/#base64,T3BhbC5xdWV1ZShmdW5jdGlvbihPcGFsKSB7LyogR2VuZXJhdGVkIGJ5IE9wYWwgMS4zLjAgKi8KICB2YXIgJCQxLCBzZWxmID0gT3BhbC50b3AsICRuZXN0aW5nID0gW10sIG5pbCA9IE9wYWwubmlsLCAkJCQgPSBPcGFsLiQkJCwgJCQgPSBPcGFsLiQkLCAkc2VuZCA9IE9wYWwuc2VuZDsKCiAgT3BhbC5hZGRfc3R1YnMoWyckZWFjaCcsICckcCddKTsKICByZXR1cm4gJHNlbmQoWzEsIDIsIDMsIDRdLCAnZWFjaCcsIFtdLCAoJCQxID0gZnVuY3Rpb24oaSl7dmFyIHNlbGYgPSAkJDEuJCRzID09IG51bGwgPyB0aGlzIDogJCQxLiQkczsKCiAgICAKICAgIAogICAgaWYgKGkgPT0gbnVsbCkgewogICAgICBpID0gbmlsOwogICAgfTsKICAgIHJldHVybiBzZWxmLiRwKGkpO30sICQkMS4kJHMgPSBzZWxmLCAkJDEuJCRhcml0eSA9IDEsICQkMSkpCn0pOwo=,eyJ2ZXJzaW9uIjozLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyItZSJdLCJzb3VyY2VzQ29udGVudCI6WyJbMSwyLDMsNF0uZWFjaCB7IHxpfCBwIGkgfSJdLCJuYW1lcyI6WyI8bWFpbj4iLCJlYWNoIiwiMSIsIjIiLCIzIiwiNCIsImJsb2NrIGluIDxtYWluPiIsImkiLCJibG9jayAoMiBsZXZlbHMpIGluIDxtYWluPiIsInNlbGYiLCJwIl0sIm1hcHBpbmdzIjoiQUFBQUEsMkJBQUFBO0VBQUFBOztFQUFBQTtFQUFBQSxPQUFTQyxNQUFULENBQUNDLENBQUQsRUFBR0MsQ0FBSCxFQUFLQyxDQUFMLEVBQU9DLENBQVAsQ0FBU0osUUFBQUEsRUFBQUEsRUFBQUEsRUFBTUssZ0JBQUdDLENBQUhELEVBQUFFOzs7O0lBQUc7SUFBQTtJQUFBO0lBQUdBLE9BQUFDLElBQUFDLEdBQUFBLENBQUVILENBQUZHLEVBQU5KLGtCQUFBQSxpQkFBQUEsS0FBTkw7QUFBVEQ7In0=,WzEsMiwzLDRdLmVhY2ggeyB8aXwgcCBpIH0=&#x000A;</code></pre></div>&#x000A;<p>This utility can be also used to help you understand which Ruby code corresponds to which JavaScript output, for educational purposes.</p>&#x000A;&#x000A;<h3 id="cache-for-opal-builder">Cache for <code>Opal::Builder</code></h3>&#x000A;&#x000A;<p><em>Sprockets doesn&#39;t use <code>Opal::Builder</code> - it has its own cache, though it may need to be configured.</em></p>&#x000A;&#x000A;<p>Upgrade to Opal 1.3 and forget the long compilation times when using <code>opal</code> command line tool or <code>Opal::Builder</code> thru any other means (like <code>Opal::SimpleServer</code>). This is implemented by caching the marshaled Compiler objects.</p>&#x000A;&#x000A;<p>4x improvement for a simple script:</p>&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ time opal _1.2.0_ -e 'p 123'&#x000A;123&#x000A;&#x000A;real    0m2.321s&#x000A;user    0m2.213s&#x000A;sys    0m0.107s&#x000A;$ time opal _1.3.0_ -e 'p 123'&#x000A;123&#x000A;&#x000A;real    0m0.537s&#x000A;user    0m0.450s&#x000A;sys    0m0.090s&#x000A;</code></pre></div>&#x000A;<p>8x when including more core, e.g. <code>opal-parser</code>:</p>&#x000A;<div class="highlight"><pre class="highlight plaintext"><code>$ time opal _1.2.0_ -ropal-parser -e 'p eval("(0..1)")'&#x000A;Object freezing is not supported by Opal&#x000A;0..1&#x000A;&#x000A;real    0m12.555s&#x000A;user    0m12.250s&#x000A;sys    0m0.349s&#x000A;$ time opal _1.3.0_ -ropal-parser -e 'p eval("(0..1)")'&#x000A;Object freezing is not supported by Opal&#x000A;0..1&#x000A;&#x000A;real    0m1.512s&#x000A;user    0m1.405s&#x000A;sys    0m0.249s&#x000A;</code></pre></div>&#x000A;<h2 id="async-await-support">Async/await support</h2>&#x000A;&#x000A;<p><em>This big feature is experimental, and may totally change in future releases of Opal.</em></p>&#x000A;&#x000A;<p>This complements the <code>PromiseV2</code> feature introduced in Opal v1.2 and uses magic comments and a supported library (aptly named <code>async</code>) to <strong>await</strong> on JavaScript native promises.</p>&#x000A;&#x000A;<p>Check it out:</p>&#x000A;<div class="highlight"><pre class="highlight ruby"><code><span class="c1"># await: sleep</span>&#x000A;<span class="nb">require</span> <span class="s2">"await"</span>&#x000A;&#x000A;<span class="nb">puts</span> <span class="s2">"Let's wait 2 seconds..."</span>&#x000A;<span class="nb">sleep</span> <span class="mi">2</span>&#x000A;<span class="nb">puts</span> <span class="s2">"Done!"</span>&#x000A;</code></pre></div>&#x000A;<p>Please consult documentation of this feature: https://opalrb.com/docs/guides/v1.3.0/async</p>&#x000A;&#x000A;<p>We are leaving this as experimental, because, as an Opal specific feature. Although it&#39;s not supported by Ruby itself the syntax is fully compatible, maybe some unexpected breakthrough will happen, with a port to a gem or to the language itself.</p>&#x000A;&#x000A;<h2 id="conclusion">Conclusion</h2>&#x000A;&#x000A;<p>Are you starting to make a new web application and don&#39;t want to be forced to write JavaScript on the frontend?</p>&#x000A;&#x000A;<p>If you are adventurous, why not try Opal? You may be surprised how ready it is for your usecase! :D</p>&#x000A;&#x000A;<hr>&#x000A;&#x000A;<h3 id="resources">Resources</h3>&#x000A;&#x000A;<ul>&#x000A;<li><a href="https://github.com/opal/opal/releases/tag/v1.3.0">Changelog for v1.3.0</a></li>&#x000A;<li><a href="https://github.com/opal/opal/releases/tag/v1.3.1">Changelog for v1.3.1</a></li>&#x000A;<li><a href="https://github.com/opal/opal/compare/v1.2.0...v1.3.1">List of commits</a> / <a href="https://github.com/opal/opal/compare/v1.2.0...v1.3.1.diff">raw diff</a></li>&#x000A;<li><a href="https://opalrb.com">Updated website</a></li>&#x000A;<li><a href="http://opalrb.com/docs/">Documentation</a></li>&#x000A;</ul>&#x000A;</div>
</article>

  </div>

  </div>

  <footer>
  <a href="/license"><i class="ion-unlocked"></i> License</a> ·
  <a href="https://github.com/opal/opal/graphs/contributors"><i class="ion-fork-repo"></i> Contributors</a>
</footer>


  <script>
    document.querySelector(`a[href="${location.pathname.replace(/\/$/,'')}"]`)?.parentElement.classList.add("active")
  </script>

  <!-- Algolia -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
  <script type="text/javascript">
    docsearch({
      apiKey: 'cf08db1eca77cb92ca34e24a86430bcb',
      indexName: 'opalrb',
      inputSelector: '#search-form input[type="search"]',
      debug: false // Set debug to true if you want to inspect the dropdown
    });
  </script>
</body>
</html>
